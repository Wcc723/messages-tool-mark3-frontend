import{d as Z,M as ee,c as h,r as u,o as te,a as r,b as e,e as l,h as p,z as k,F as I,l as U,t as o,w as se,s as v,g as V,E as B,v as ne,i as re,j as a}from"./index-Dg8mVS7j.js";import{u as ae}from"./checkin-BVocAZFq.js";import{u as oe}from"./discord-D0xgS0n4.js";import{u as ie}from"./useToast-WH4QaZkr.js";const le={class:"space-y-6"},de={class:"flex items-center justify-between"},ce={class:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"},ue={class:"relative"},ge={class:"min-w-full divide-y divide-gray-200"},pe={class:"bg-white divide-y divide-gray-200"},xe={key:0},ye={key:1},be={colspan:"7",class:"px-6 py-10 text-center text-gray-500"},ve={class:"flex flex-col items-center gap-2"},me={class:"px-6 py-4 whitespace-nowrap"},fe={class:"text-sm font-semibold text-gray-800"},he={class:"text-xs text-gray-500"},ke={class:"px-6 py-4 whitespace-nowrap"},we={class:"text-sm text-gray-700"},_e={class:"px-6 py-4 whitespace-nowrap"},Ce={class:"text-sm text-gray-700"},Se={class:"text-xs text-gray-500"},De={class:"px-6 py-4"},Me={key:0,class:"flex flex-wrap gap-1"},Re={key:1,class:"text-sm text-gray-400"},Te={class:"px-6 py-4 whitespace-nowrap"},$e=["onClick"],Ie={class:"px-6 py-4"},Ve={class:"flex items-center gap-2"},je=["title"],Ee=["title","onClick"],Le=["href"],Ne={class:"px-6 py-4 whitespace-nowrap text-right"},Ue={class:"inline-flex items-center gap-2"},Be=["onClick"],Fe=["onClick"],ze=["onClick"],Ae=["onClick"],qe={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700"},Pe={class:"bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6 space-y-4"},Ge={class:"space-y-4"},He={class:"text-sm text-gray-600"},Je={class:"font-semibold text-gray-800"},Ke={class:"space-y-3"},Oe={key:0,class:"space-y-2"},Qe={key:1,class:"mt-4 p-4 bg-gray-50 rounded-lg"},We={class:"flex items-center justify-between mb-2"},Xe=["disabled"],Ye={class:"flex items-center gap-2"},Ze={class:"text-sm"},et={key:0,class:"mt-2 text-xs text-gray-500"},tt={key:1,class:"mt-2 text-xs text-red-600"},st={key:2,class:"mt-3 p-3 bg-white rounded border border-gray-200"},nt={class:"text-xs text-gray-600 mt-1"},rt={key:0,class:"text-xs text-gray-500 mt-1"},at={class:"flex items-center justify-end gap-3 pt-4 border-t border-gray-200"},ot=["disabled"],it=["disabled"],lt={key:0,class:"bi bi-arrow-repeat animate-spin"},xt=Z({__name:"CheckinScheduleListView",setup(dt){const C=re(),d=ae(),S=oe(),{hasPermission:D}=ee(),x=ie(),j=h(()=>D("checkin","canCreate")),F=h(()=>D("checkin","canEdit")),z=h(()=>D("checkin","canDelete")),M=u(!1),R=u(""),T=u(""),c=u("all"),y=u(""),m=u(!1),f=u(null),i=u(null),b=u(null),w=u(!1),A=h(()=>{if(!i.value)return"bg-gray-400";switch(i.value.status){case"queued":return"bg-yellow-500";case"running":return"bg-blue-500";case"completed":return"bg-emerald-500";case"failed":return"bg-red-500";default:return"bg-gray-400"}}),q=h(()=>{if(!i.value)return"未知";switch(i.value.status){case"queued":return"排隊中";case"running":return"掃描中";case"completed":return"已完成";case"failed":return"失敗";default:return i.value.status}});function P(n){const t=S.channels.find(s=>s.id===n);return t?`#${t.name}`:"未知頻道"}async function G(n,t){const s=n||t,g=n?"Slug":"排程 ID";try{await navigator.clipboard.writeText(s),x.success(`${g} 已複製到剪貼簿`)}catch($){console.error("複製失敗:",$),x.error("複製失敗，請手動複製")}}async function H(n,t){if(confirm(`確定要刪除排程「${t}」嗎？此操作無法復原。`))try{await d.deleteSchedule(n),x.success("排程已刪除")}catch{x.error(d.error||"刪除失敗")}}async function J(n){try{await d.toggleSchedule(n)}catch{x.error(d.error||"切換狀態失敗")}}function K(n,t){R.value=n,T.value=t,c.value="all",y.value="",f.value=null,i.value=null,b.value=null,M.value=!0}function _(){M.value=!1,R.value="",T.value="",c.value="all",y.value=""}async function O(){if(c.value==="single"&&!y.value){x.warning("請選擇要掃描的日期");return}m.value=!0;try{const n=await d.rescanSchedule(R.value,c.value==="single"?y.value:void 0);if(n)f.value=n,await E();else{const t=c.value==="all"?"已開始重新掃描全部日期":`已開始重新掃描 ${y.value}`;x.success(t),_()}}catch{x.error(d.error||"掃描失敗")}finally{m.value=!1}}async function E(){if(f.value){w.value=!0;try{i.value=await d.fetchScanStatus(f.value),i.value.status==="completed"&&(b.value=await d.fetchScanResult(f.value))}catch(n){console.error("取得掃描狀態失敗:",n)}finally{w.value=!1}}}function Q(n){C.push({name:"CheckinScheduleReport",params:{id:n}})}function W(n){C.push({name:"CheckinScheduleEdit",params:{id:n}})}function L(){C.push({name:"CheckinScheduleCreate"})}const X=h(()=>(d.schedules?.length??0)>0),N="https://daily-checkin-task.hexschool.io";function Y(n,t){return`${N}/#/${n||t}`}return te(async()=>{S.channels.length===0&&await S.fetchChannels().catch(()=>{});try{await d.fetchSchedules()}catch(n){console.error("載入排程失敗:",n)}}),(n,t)=>(a(),r("div",le,[e("header",de,[t[4]||(t[4]=e("div",null,[e("h1",{class:"text-2xl font-bold text-gray-800"},"打卡排程管理"),e("p",{class:"text-gray-600 mt-1"},"管理 Discord 頻道的打卡排程設定")],-1)),j.value?(a(),r("button",{key:0,type:"button",class:"inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition cursor-pointer",onClick:L},[...t[3]||(t[3]=[e("i",{class:"bi bi-plus-circle"},null,-1),p(" 新增排程 ",-1)])])):l("",!0)]),e("section",ce,[e("div",ue,[e("table",ge,[t[15]||(t[15]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 排程名稱 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," Discord 頻道 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 日期範圍 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 關鍵字 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 狀態 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," Slug / ID "),e("th",{class:"px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 操作 ")])],-1)),e("tbody",pe,[k(d).isLoading?(a(),r("tr",xe,[...t[5]||(t[5]=[e("td",{colspan:"7",class:"px-6 py-16 text-center"},[e("div",{class:"flex flex-col items-center gap-3"},[e("div",{class:"relative"},[e("div",{class:"w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"})]),e("div",{class:"text-gray-600"},[e("p",{class:"font-medium"},"載入排程資料中"),e("p",{class:"text-sm text-gray-400 mt-1"},"請稍候...")])])],-1)])])):X.value?(a(!0),r(I,{key:2},U(k(d).schedules||[],s=>(a(),r("tr",{key:s.id,class:"hover:bg-gray-50 transition"},[e("td",me,[e("div",null,[e("p",fe,o(s.name),1),e("p",he," 預期討論串: "+o(s.expectedThreadCount||"-")+" 個 ",1)])]),e("td",ke,[e("p",we,o(P(s.channelId)),1)]),e("td",_e,[e("div",Ce,[e("div",null,o(s.startDate),1),e("div",Se,"至 "+o(s.endDate),1)])]),e("td",De,[s.keywords&&s.keywords.length>0?(a(),r("div",Me,[(a(!0),r(I,null,U(s.keywords,(g,$)=>(a(),r("span",{key:$,class:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"},o(g),1))),128))])):(a(),r("span",Re,"全部訊息"))]),e("td",Te,[e("button",{type:"button",class:v(["inline-flex items-center gap-2 text-sm font-medium cursor-pointer",s.isActive?"text-emerald-600":"text-gray-400"]),onClick:g=>J(s.id)},[e("span",{class:v(["w-2 h-2 rounded-full",s.isActive?"bg-emerald-500":"bg-gray-400"])},null,2),p(" "+o(s.isActive?"啟用":"停用"),1)],10,$e)]),e("td",Ie,[e("div",Ve,[e("span",{class:v(["text-xs font-mono truncate max-w-[100px]",s.slug?"text-indigo-600":"text-gray-600"]),title:s.slug||s.id},o(s.slug||s.id),11,je),e("button",{type:"button",class:"text-gray-400 hover:text-gray-600 transition cursor-pointer",title:s.slug?"複製 Slug":"複製排程 ID",onClick:g=>G(s.slug,s.id)},[...t[9]||(t[9]=[e("i",{class:"bi bi-clipboard text-sm"},null,-1)])],8,Ee),k(N)?(a(),r("a",{key:0,href:Y(s.slug,s.id),target:"_blank",rel:"noopener noreferrer",class:"text-gray-400 hover:text-indigo-600 transition",title:"開啟打卡頁面"},[...t[10]||(t[10]=[e("i",{class:"bi bi-box-arrow-up-right text-sm"},null,-1)])],8,Le)):l("",!0)])]),e("td",Ne,[e("div",Ue,[e("button",{type:"button",class:"p-2 text-gray-600 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition cursor-pointer",title:"查看報告",onClick:g=>Q(s.id)},[...t[11]||(t[11]=[e("i",{class:"bi bi-bar-chart-line"},null,-1)])],8,Be),e("button",{type:"button",class:"p-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition cursor-pointer",title:"重新掃描",onClick:g=>K(s.id,s.name)},[...t[12]||(t[12]=[e("i",{class:"bi bi-arrow-clockwise"},null,-1)])],8,Fe),F.value?(a(),r("button",{key:0,type:"button",class:"p-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition cursor-pointer",title:"編輯",onClick:g=>W(s.id)},[...t[13]||(t[13]=[e("i",{class:"bi bi-pencil"},null,-1)])],8,ze)):l("",!0),z.value?(a(),r("button",{key:1,type:"button",class:"p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition cursor-pointer",title:"刪除",onClick:g=>H(s.id,s.name)},[...t[14]||(t[14]=[e("i",{class:"bi bi-trash"},null,-1)])],8,Ae)):l("",!0)])])]))),128)):(a(),r("tr",ye,[e("td",be,[e("div",ve,[t[7]||(t[7]=e("i",{class:"bi bi-clipboard-check text-3xl text-gray-300"},null,-1)),t[8]||(t[8]=e("span",null,"尚無打卡排程",-1)),j.value?(a(),r("button",{key:0,type:"button",class:"mt-2 inline-flex items-center gap-2 px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition cursor-pointer",onClick:L},[...t[6]||(t[6]=[e("i",{class:"bi bi-plus-circle"},null,-1),p(" 建立第一個排程 ",-1)])])):l("",!0)])])]))])])])]),k(d).error?(a(),r("div",qe,o(k(d).error),1)):l("",!0),M.value?(a(),r("div",{key:1,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",onClick:se(_,["self"])},[e("div",Pe,[e("div",{class:"flex items-center justify-between border-b border-gray-200 pb-3"},[t[17]||(t[17]=e("h3",{class:"text-lg font-semibold text-gray-800"},"重新掃描排程",-1)),e("button",{type:"button",class:"text-gray-400 hover:text-gray-600 transition",onClick:_},[...t[16]||(t[16]=[e("i",{class:"bi bi-x-lg text-xl"},null,-1)])])]),e("div",Ge,[e("p",He,[t[18]||(t[18]=p(" 排程：",-1)),e("span",Je,o(T.value),1)]),e("div",Ke,[t[21]||(t[21]=e("label",{class:"block text-sm font-medium text-gray-700"},"掃描範圍",-1)),e("label",{class:v(["flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition",c.value==="all"?"border-indigo-500 bg-indigo-50":"border-gray-300"])},[V(e("input",{type:"radio","onUpdate:modelValue":t[0]||(t[0]=s=>c.value=s),value:"all",class:"w-4 h-4 text-indigo-600"},null,512),[[B,c.value]]),t[19]||(t[19]=e("div",{class:"flex-1"},[e("div",{class:"font-medium text-gray-800"},"掃描全部日期"),e("div",{class:"text-xs text-gray-500"},"重新掃描排程內所有日期的討論串")],-1))],2),e("label",{class:v(["flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition",c.value==="single"?"border-indigo-500 bg-indigo-50":"border-gray-300"])},[V(e("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=s=>c.value=s),value:"single",class:"w-4 h-4 text-indigo-600"},null,512),[[B,c.value]]),t[20]||(t[20]=e("div",{class:"flex-1"},[e("div",{class:"font-medium text-gray-800"},"掃描單一日期"),e("div",{class:"text-xs text-gray-500"},"指定特定日期進行掃描")],-1))],2)]),c.value==="single"?(a(),r("div",Oe,[t[22]||(t[22]=e("label",{for:"rescanDate",class:"block text-sm font-medium text-gray-700"},[p(" 選擇日期 "),e("span",{class:"text-red-500"},"*")],-1)),V(e("input",{id:"rescanDate",type:"date","onUpdate:modelValue":t[2]||(t[2]=s=>y.value=s),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[ne,y.value]])])):l("",!0),f.value?(a(),r("div",Qe,[e("div",We,[t[24]||(t[24]=e("span",{class:"text-sm font-medium text-gray-700"},"掃描狀態",-1)),e("button",{type:"button",class:"text-sm text-indigo-600 hover:text-indigo-800 inline-flex items-center gap-1 cursor-pointer",disabled:w.value,onClick:E},[e("i",{class:v(["bi bi-arrow-clockwise",{"animate-spin":w.value}])},null,2),t[23]||(t[23]=p(" 刷新 ",-1))],8,Xe)]),e("div",Ye,[e("span",{class:v(["w-2 h-2 rounded-full",A.value])},null,2),e("span",Ze,o(q.value),1)]),i.value?.progress?(a(),r("div",et,[p(" 階段: "+o(i.value.progress.phase)+" ",1),t[26]||(t[26]=e("br",null,null,-1)),p(" 處理中: "+o(i.value.progress.processedThreads)+" / "+o(i.value.progress.totalThreads)+" 討論串 ",1),i.value.progress.currentThread?(a(),r(I,{key:0},[t[25]||(t[25]=e("br",null,null,-1)),p(" 目前: "+o(i.value.progress.currentThread.name),1)],64)):l("",!0)])):l("",!0),i.value?.errorMessage?(a(),r("div",tt," 錯誤: "+o(i.value.errorMessage),1)):l("",!0),b.value?(a(),r("div",st,[t[27]||(t[27]=e("p",{class:"text-sm font-medium text-gray-800"},"掃描完成",-1)),e("p",nt," 發現 "+o(b.value.threadsFound)+" 個討論串， 記錄 "+o(b.value.checkinsRecorded)+" 筆打卡 ",1),b.value.duration?(a(),r("p",rt," 耗時: "+o(Math.round(b.value.duration/1e3))+" 秒 ",1)):l("",!0)])):l("",!0)])):l("",!0)]),e("div",at,[e("button",{type:"button",class:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition disabled:opacity-50",disabled:m.value,onClick:_}," 取消 ",8,ot),e("button",{type:"button",class:"px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2",disabled:m.value,onClick:O},[m.value?(a(),r("i",lt)):l("",!0),e("span",null,o(m.value?"掃描中...":"開始掃描"),1)],8,it)])])])):l("",!0)]))}});export{xt as default};
