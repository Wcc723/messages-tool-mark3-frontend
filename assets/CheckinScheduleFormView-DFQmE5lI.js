import{d as R,c as y,m as O,r as f,o as Y,i as A,a as r,b as t,t as u,e as p,g as a,h as d,v as g,F as I,l as T,s as M,E as H,O as G,w as N,z as S,j as l}from"./index-CCl1Cf0n.js";import{u as J}from"./checkin-DWLF-Nbu.js";import{u as P}from"./discord-B1OxcOyW.js";const Q={class:"space-y-6 max-w-4xl mx-auto"},W={class:"text-2xl font-bold text-gray-800"},X={class:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-4"},Z={class:"relative"},_={key:0,class:"text-gray-800"},ee={key:0,class:"text-xs text-gray-500 ml-2"},te={key:1,class:"text-gray-500"},se={key:0,class:"absolute z-10 w-full mt-2 bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-auto"},oe={class:"p-3 border-b border-gray-200 sticky top-0 bg-white"},ne={class:"py-2"},re={class:"px-3 py-1 text-xs font-semibold text-gray-500 uppercase"},le=["onClick"],ae={class:"flex-1 text-sm"},de={key:0,class:"bi bi-check2 text-indigo-600 text-lg"},ie={key:0,class:"px-4 py-8 text-center text-gray-500 text-sm"},ue={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ce={class:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-4"},pe={class:"space-y-3"},ge={class:"flex-1"},xe={key:0,class:"mt-3"},be={class:"flex items-center gap-2"},me={class:"flex gap-2 mb-2"},ve=["onKeydown"],ye={key:0,class:"flex flex-wrap gap-2"},fe=["onClick"],he={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700"},ke={class:"sticky bottom-0 bg-white border-t border-gray-200 p-4 flex items-center justify-end gap-3"},we=["disabled"],De={key:0},Ce={key:1},He=R({__name:"CheckinScheduleFormView",setup(Me){const V=A(),$=O(),i=J(),b=P(),m=y(()=>$.params.id),h=y(()=>!!m.value),v=f(""),k=f(!1),w=f(!1),D=f(""),s=f({name:"",channelId:"",startDate:"",endDate:"",keywords:[],expectedThreadCount:void 0,checkinMode:"standard",extendedHours:void 0}),U=y(()=>{if(!v.value)return b.textChannels;const o=v.value.toLowerCase();return b.textChannels.filter(e=>e.name.toLowerCase().includes(o))}),E=y(()=>{const o={};return U.value.forEach(e=>{const n=e.parentName||"未分類";o[n]||(o[n]=[]),o[n].push(e)}),o}),C=y(()=>b.channels.find(o=>o.id===s.value.channelId));function K(o){s.value.channelId=o,k.value=!1,v.value=""}function F(){const o=D.value.trim();o&&!s.value.keywords.includes(o)&&(s.value.keywords.push(o),D.value="")}function L(o){s.value.keywords.splice(o,1)}function B(){if(!s.value.name.trim())return"請輸入排程名稱";if(!s.value.channelId)return"請選擇 Discord 頻道";if(!s.value.startDate)return"請選擇開始日期";if(!s.value.endDate)return"請選擇結束日期";const o=new Date(s.value.startDate);if(new Date(s.value.endDate)<o)return"結束日期不可早於開始日期";if(s.value.checkinMode==="extended"){if(!s.value.extendedHours)return"請輸入延後計算時數";if(s.value.extendedHours<1||s.value.extendedHours>72)return"延後計算時數須在 1-72 小時之間"}return null}async function j(){const o=B();if(o){alert(o);return}w.value=!0;try{const e={name:s.value.name.trim(),channelId:s.value.channelId,startDate:s.value.startDate,endDate:s.value.endDate,keywords:s.value.keywords.length>0?s.value.keywords:void 0,expectedThreadCount:s.value.expectedThreadCount,checkinMode:s.value.checkinMode,extendedHours:s.value.checkinMode==="extended"?s.value.extendedHours:void 0};h.value&&m.value?(await i.updateSchedule(m.value,e),alert("排程已更新！")):(await i.createSchedule(e),alert("排程已建立！")),V.push({name:"CheckinSchedules"})}catch(e){console.error("Failed to save schedule:",e),alert(i.error||"操作失敗")}finally{w.value=!1}}function q(){confirm("確定要取消嗎？未儲存的變更將會遺失。")&&V.push({name:"CheckinSchedules"})}function z(){const o=new Date,e=o.getFullYear(),n=String(o.getMonth()+1).padStart(2,"0"),c=String(o.getDate()).padStart(2,"0");return`${e}-${n}-${c}`}return Y(async()=>{if(b.channels.length===0&&await b.fetchChannels(),h.value&&m.value)try{const o=await i.fetchScheduleById(m.value);s.value={name:o.name,channelId:o.channelId,startDate:o.startDate,endDate:o.endDate,keywords:o.keywords||[],expectedThreadCount:o.expectedThreadCount,checkinMode:o.checkinMode||"standard",extendedHours:o.extendedHours}}catch{alert("載入排程失敗"),V.push({name:"CheckinSchedules"})}else s.value.startDate=z()}),(o,e)=>(l(),r("div",Q,[t("header",null,[t("h1",W,u(h.value?"編輯打卡排程":"新增打卡排程"),1),e[11]||(e[11]=t("p",{class:"text-gray-600 mt-1"},"設定 Discord 頻道的打卡監控排程",-1))]),t("form",{onSubmit:N(j,["prevent"]),class:"space-y-6"},[t("section",X,[e[19]||(e[19]=t("div",{class:"flex items-center gap-3 border-b border-gray-200 pb-3"},[t("i",{class:"bi bi-info-circle text-indigo-600 text-lg"}),t("h2",{class:"text-lg font-semibold text-gray-800"},"基本設定")],-1)),t("div",null,[e[12]||(e[12]=t("label",{for:"name",class:"block text-sm font-medium text-gray-700 mb-1"},[d(" 排程名稱 "),t("span",{class:"text-red-500"},"*")],-1)),a(t("input",{id:"name","onUpdate:modelValue":e[0]||(e[0]=n=>s.value.name=n),type:"text",required:"",maxlength:"100",placeholder:"例如：2025 年度打卡活動",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[g,s.value.name]])]),t("div",null,[e[16]||(e[16]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},[d(" Discord 頻道 "),t("span",{class:"text-red-500"},"*")],-1)),t("div",Z,[t("button",{type:"button",class:"w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer",onClick:e[1]||(e[1]=n=>k.value=!k.value)},[C.value?(l(),r("span",_,[e[13]||(e[13]=t("i",{class:"bi bi-hash text-gray-400"},null,-1)),d(" "+u(C.value.name)+" ",1),C.value.parentName?(l(),r("span",ee," ("+u(C.value.parentName)+") ",1)):p("",!0)])):(l(),r("span",te,"請選擇頻道")),e[14]||(e[14]=t("i",{class:"bi bi-chevron-down text-gray-400"},null,-1))]),k.value?(l(),r("div",se,[t("div",oe,[a(t("input",{"onUpdate:modelValue":e[2]||(e[2]=n=>v.value=n),type:"text",placeholder:"搜尋頻道...",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[g,v.value]])]),t("div",ne,[(l(!0),r(I,null,T(E.value,(n,c)=>(l(),r("div",{key:c,class:"mb-3"},[t("div",re,u(c),1),(l(!0),r(I,null,T(n,x=>(l(),r("button",{key:x.id,type:"button",class:M(["w-full px-4 py-2 text-left hover:bg-gray-50 cursor-pointer flex items-center gap-2",{"bg-indigo-50":s.value.channelId===x.id}]),onClick:Se=>K(x.id)},[e[15]||(e[15]=t("i",{class:"bi bi-hash text-gray-400"},null,-1)),t("span",ae,u(x.name),1),s.value.channelId===x.id?(l(),r("i",de)):p("",!0)],10,le))),128))]))),128))]),U.value.length===0?(l(),r("div",ie," 找不到符合的頻道 ")):p("",!0)])):p("",!0)])]),t("div",ue,[t("div",null,[e[17]||(e[17]=t("label",{for:"startDate",class:"block text-sm font-medium text-gray-700 mb-1"},[d(" 開始日期 "),t("span",{class:"text-red-500"},"*")],-1)),a(t("input",{id:"startDate","onUpdate:modelValue":e[3]||(e[3]=n=>s.value.startDate=n),type:"date",required:"",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[g,s.value.startDate]])]),t("div",null,[e[18]||(e[18]=t("label",{for:"endDate",class:"block text-sm font-medium text-gray-700 mb-1"},[d(" 結束日期 "),t("span",{class:"text-red-500"},"*")],-1)),a(t("input",{id:"endDate","onUpdate:modelValue":e[4]||(e[4]=n=>s.value.endDate=n),type:"date",required:"",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[g,s.value.endDate]])])])]),t("section",ce,[e[34]||(e[34]=t("div",{class:"flex items-center gap-3 border-b border-gray-200 pb-3"},[t("i",{class:"bi bi-sliders text-indigo-600 text-lg"}),t("h2",{class:"text-lg font-semibold text-gray-800"},"進階設定")],-1)),t("div",null,[e[27]||(e[27]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[d(" 打卡計算模式 "),t("span",{class:"text-red-500"},"*")],-1)),t("div",pe,[t("label",{class:M(["flex items-start gap-3 p-3 border rounded-lg cursor-pointer transition",s.value.checkinMode==="standard"?"border-indigo-500 bg-indigo-50":"border-gray-200 hover:border-gray-300"])},[a(t("input",{"onUpdate:modelValue":e[5]||(e[5]=n=>s.value.checkinMode=n),type:"radio",name:"checkinMode",value:"standard",class:"mt-1"},null,512),[[H,s.value.checkinMode]]),e[20]||(e[20]=t("div",{class:"flex-1"},[t("div",{class:"font-medium text-gray-800"},"標準模式（24小時內）"),t("p",{class:"text-xs text-gray-500 mt-1"}," 用戶須在討論串建立後 24 小時內留言，才算打卡成功 ")],-1))],2),t("label",{class:M(["flex items-start gap-3 p-3 border rounded-lg cursor-pointer transition",s.value.checkinMode==="extended"?"border-indigo-500 bg-indigo-50":"border-gray-200 hover:border-gray-300"])},[a(t("input",{"onUpdate:modelValue":e[6]||(e[6]=n=>s.value.checkinMode=n),type:"radio",name:"checkinMode",value:"extended",class:"mt-1"},null,512),[[H,s.value.checkinMode]]),t("div",ge,[e[24]||(e[24]=t("div",{class:"font-medium text-gray-800"},"延後計算時間",-1)),e[25]||(e[25]=t("p",{class:"text-xs text-gray-500 mt-1"}," 用戶在當日結束後的指定時數內留言，仍可被計算為打卡成功 ",-1)),s.value.checkinMode==="extended"?(l(),r("div",xe,[e[22]||(e[22]=t("label",{class:"block text-xs font-medium text-gray-600 mb-1"}," 延後時數（1-72 小時） ",-1)),t("div",be,[a(t("input",{"onUpdate:modelValue":e[7]||(e[7]=n=>s.value.extendedHours=n),type:"number",min:"1",max:"72",placeholder:"12",class:"w-24 px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"},null,512),[[g,s.value.extendedHours,void 0,{number:!0}]]),e[21]||(e[21]=t("span",{class:"text-sm text-gray-500"},"小時",-1))]),e[23]||(e[23]=t("p",{class:"text-xs text-gray-400 mt-1"}," 例如：設定 12 小時，則用戶在隔日中午 12 點前留言皆可計算 ",-1))])):p("",!0)])],2),t("label",{class:M(["flex items-start gap-3 p-3 border rounded-lg cursor-pointer transition",s.value.checkinMode==="all_period"?"border-indigo-500 bg-indigo-50":"border-gray-200 hover:border-gray-300"])},[a(t("input",{"onUpdate:modelValue":e[8]||(e[8]=n=>s.value.checkinMode=n),type:"radio",name:"checkinMode",value:"all_period",class:"mt-1"},null,512),[[H,s.value.checkinMode]]),e[26]||(e[26]=t("div",{class:"flex-1"},[t("div",{class:"font-medium text-gray-800"},"不分時段"),t("p",{class:"text-xs text-gray-500 mt-1"}," 用戶在整個排程期間（開始日期至結束日期）內的任何時間留言，均可被計算為打卡成功 ")],-1))],2)])]),t("div",null,[e[30]||(e[30]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," 關鍵字篩選（可選） ",-1)),e[31]||(e[31]=t("p",{class:"text-xs text-gray-500 mb-2"}," 輸入關鍵字以篩選討論串標題。若不設定，則會截取所有討論串。 ",-1)),t("div",me,[a(t("input",{"onUpdate:modelValue":e[9]||(e[9]=n=>D.value=n),type:"text",placeholder:"輸入關鍵字...",class:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500",onKeydown:G(N(F,["prevent"]),["enter"])},null,40,ve),[[g,D.value]]),t("button",{type:"button",class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition cursor-pointer",onClick:F},[...e[28]||(e[28]=[t("i",{class:"bi bi-plus-lg"},null,-1)])])]),s.value.keywords.length>0?(l(),r("div",ye,[(l(!0),r(I,null,T(s.value.keywords,(n,c)=>(l(),r("span",{key:c,class:"inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm"},[d(u(n)+" ",1),t("button",{type:"button",class:"hover:text-blue-600 cursor-pointer",onClick:x=>L(c)},[...e[29]||(e[29]=[t("i",{class:"bi bi-x text-lg"},null,-1)])],8,fe)]))),128))])):p("",!0)]),t("div",null,[e[32]||(e[32]=t("label",{for:"expectedThreadCount",class:"block text-sm font-medium text-gray-700 mb-1"}," 預期討論串數目（可選） ",-1)),a(t("input",{id:"expectedThreadCount","onUpdate:modelValue":e[10]||(e[10]=n=>s.value.expectedThreadCount=n),type:"number",min:"0",placeholder:"例如：30",class:"w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[g,s.value.expectedThreadCount,void 0,{number:!0}]]),e[33]||(e[33]=t("p",{class:"text-xs text-gray-500 mt-1"},"用於預估排程的討論串總數",-1))])]),S(i).error?(l(),r("div",he,u(S(i).error),1)):p("",!0),t("div",ke,[t("button",{type:"button",class:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition cursor-pointer",onClick:q}," 取消 "),t("button",{type:"submit",class:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",disabled:w.value||S(i).isLoading},[w.value||S(i).isLoading?(l(),r("span",De,[...e[35]||(e[35]=[t("i",{class:"bi bi-arrow-repeat animate-spin"},null,-1),d(" 儲存中... ",-1)])])):(l(),r("span",Ce,[e[36]||(e[36]=t("i",{class:"bi bi-check2"},null,-1)),d(" "+u(h.value?"更新排程":"建立排程"),1)]))],8,we)])],32)]))}});export{He as default};
