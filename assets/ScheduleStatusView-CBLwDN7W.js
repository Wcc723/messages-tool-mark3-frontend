import{d as q,z as B,r as d,c as _,o as G,a as l,b as e,h as H,t as a,g as u,v as w,A as F,F as S,l as k,e as D,s as J,i as Q,j as r}from"./index-ixJDyiIs.js";import{u as X}from"./schedule-C-SfVZAL.js";import{u as Y}from"./discord-B6pKSInI.js";const Z={class:"max-w-7xl mx-auto"},ee={class:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-8"},te={class:"flex gap-2"},se=["disabled"],oe={class:"grid grid-cols-1 gap-4 sm:grid-cols-3 mb-8"},ae={class:"bg-white border border-gray-200 rounded-lg p-4"},le={class:"text-2xl font-semibold text-gray-900 mt-2"},re={class:"bg-white border border-gray-200 rounded-lg p-4"},de={class:"text-2xl font-semibold text-gray-900 mt-2"},ne={class:"bg-white border border-gray-200 rounded-lg p-4"},ie={class:"text-2xl font-semibold text-gray-900 mt-2"},ue={class:"bg-white border border-gray-200 rounded-lg p-6 mb-6"},ce={class:"grid grid-cols-1 gap-4 lg:grid-cols-3"},ge={class:"flex flex-col gap-2"},me={class:"flex flex-col gap-2"},pe=["value"],xe={class:"flex flex-col gap-2"},ye=["value"],fe={class:"grid grid-cols-1 gap-4 mt-4 md:grid-cols-2"},be={class:"flex flex-col gap-2"},ve={class:"flex flex-col gap-2"},he={class:"bg-white border border-gray-200 rounded-lg"},_e={key:0,class:"p-6 border-b border-gray-200 bg-red-50 text-red-700 text-sm"},we={key:1,class:"p-6 text-center text-sm text-gray-600"},Se={key:2,class:"p-10 text-center text-gray-500"},ke={key:3,class:"overflow-x-auto"},De={class:"w-full min-w-[720px] text-sm text-left"},Te={class:"divide-y divide-gray-200"},Ce={class:"px-4 py-4 align-top"},Ie={class:"font-medium text-gray-900"},Le={class:"text-xs text-gray-500 mt-1"},Ve={class:"px-4 py-4 align-top"},Ae={class:"px-4 py-4 align-top"},Be={class:"text-gray-900"},Fe={class:"text-xs text-gray-500 mt-1"},Me={class:"px-4 py-4 align-top"},Ue={class:"text-gray-900"},Ee={class:"text-xs text-gray-500 mt-1"},Ne={class:"px-4 py-4 align-top"},ze={key:0,class:"text-gray-700"},Oe={key:1,class:"text-gray-400 italic"},$e={key:2,class:"text-xs text-red-600 mt-2"},je={key:3,class:"text-xs text-gray-500 mt-2"},Ke={class:"px-4 py-4 align-top"},Re=["onClick"],He=q({__name:"ScheduleStatusView",setup(Pe){const M=Q(),f=X(),b=Y(),{schedules:T}=B(f),{channels:U}=B(b),i=d([]),c=d(!1),g=d(null),v=d(""),m=d(""),p=d(""),x=d(""),y=d(""),E=[{value:"",label:"全部狀態"},{value:"success",label:"成功"},{value:"failed",label:"失敗"},{value:"pending",label:"待處理"}],N=_(()=>T.value.map(o=>({value:o.id,label:o.title}))),h=_(()=>({success:i.value.filter(o=>o.status==="success").length,failed:i.value.filter(o=>o.status==="failed").length,pending:i.value.filter(o=>o.status==="pending").length})),C=_(()=>i.value.filter(o=>{const t=!m.value||o.status===m.value,s=!p.value||o.scheduleId===p.value,n=v.value.trim().toLowerCase(),R=n===""||o.scheduleTitle.toLowerCase().includes(n)||o.message?.toLowerCase().includes(n)||o.error?.toLowerCase().includes(n),L=new Date(o.executedAt).getTime(),V=x.value?new Date(x.value).getTime():null,A=y.value?new Date(y.value).getTime():null,P=V===null||L>=V,W=A===null||L<=A;return t&&s&&R&&P&&W})),z=o=>{const t=b.getChannelById(o);return t?`#${t.name}`:o},O=o=>({success:"bg-green-100 text-green-700 border border-green-200",failed:"bg-red-100 text-red-700 border border-red-200",pending:"bg-yellow-100 text-yellow-700 border border-yellow-200"})[o],$=o=>({success:"成功",failed:"失敗",pending:"待處理"})[o],j=o=>new Date(o).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),I=async()=>{c.value=!0,g.value=null;try{U.value.length||await b.fetchChannels(),await f.fetchSchedules();const o=await Promise.all(T.value.map(async t=>(await f.fetchScheduleLogs(t.id,{limit:50})).logs.map(n=>({...n,scheduleTitle:t.title,channelId:t.channelId}))));i.value=o.flat().sort((t,s)=>new Date(s.executedAt).getTime()-new Date(t.executedAt).getTime())}catch(o){console.error("Failed to load schedule logs:",o),g.value=o.response?.data?.message||"載入排程執行記錄失敗"}finally{c.value=!1}},K=o=>{M.push(`/dashboard/schedule/edit/${o}`)};return G(()=>{I()}),(o,t)=>(r(),l("div",Z,[e("div",ee,[t[6]||(t[6]=e("div",null,[e("h1",{class:"text-3xl font-bold text-gray-900 mb-2"},"排程狀態"),e("p",{class:"text-gray-600"},"檢視訊息發送記錄與狀態")],-1)),e("div",te,[e("button",{type:"button",onClick:I,disabled:c.value,class:"px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-colors flex items-center gap-2 disabled:cursor-not-allowed disabled:opacity-60"},[...t[5]||(t[5]=[e("i",{class:"bi bi-arrow-clockwise"},null,-1),H(" 重新整理 ",-1)])],8,se)])]),e("div",oe,[e("div",ae,[t[7]||(t[7]=e("p",{class:"text-sm text-gray-500"},"成功發送",-1)),e("p",le,a(h.value.success),1)]),e("div",re,[t[8]||(t[8]=e("p",{class:"text-sm text-gray-500"},"發送失敗",-1)),e("p",de,a(h.value.failed),1)]),e("div",ne,[t[9]||(t[9]=e("p",{class:"text-sm text-gray-500"},"待處理",-1)),e("p",ie,a(h.value.pending),1)])]),e("div",ue,[e("div",ce,[e("div",ge,[t[10]||(t[10]=e("label",{class:"text-sm font-medium text-gray-700"},"搜尋關鍵字",-1)),u(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>v.value=s),type:"text",placeholder:"搜尋排程或訊息內容",class:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"},null,512),[[w,v.value]])]),e("div",me,[t[11]||(t[11]=e("label",{class:"text-sm font-medium text-gray-700"},"狀態",-1)),u(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>m.value=s),class:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 cursor-pointer"},[(r(),l(S,null,k(E,s=>e("option",{key:s.value,value:s.value},a(s.label),9,pe)),64))],512),[[F,m.value]])]),e("div",xe,[t[13]||(t[13]=e("label",{class:"text-sm font-medium text-gray-700"},"排程",-1)),u(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>p.value=s),class:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 cursor-pointer"},[t[12]||(t[12]=e("option",{value:""},"全部排程",-1)),(r(!0),l(S,null,k(N.value,s=>(r(),l("option",{key:s.value,value:s.value},a(s.label),9,ye))),128))],512),[[F,p.value]])])]),e("div",fe,[e("div",be,[t[14]||(t[14]=e("label",{class:"text-sm font-medium text-gray-700"},"開始時間",-1)),u(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>x.value=s),type:"datetime-local",class:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"},null,512),[[w,x.value]])]),e("div",ve,[t[15]||(t[15]=e("label",{class:"text-sm font-medium text-gray-700"},"結束時間",-1)),u(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>y.value=s),type:"datetime-local",class:"w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"},null,512),[[w,y.value]])])])]),e("div",he,[g.value?(r(),l("div",_e,a(g.value),1)):D("",!0),c.value?(r(),l("div",we," 載入中... ")):C.value.length===0?(r(),l("div",Se," 目前沒有符合條件的執行記錄 ")):(r(),l("div",ke,[e("table",De,[t[16]||(t[16]=e("thead",{class:"bg-gray-50 text-gray-600 uppercase text-xs"},[e("tr",null,[e("th",{class:"px-4 py-3 font-medium"},"排程"),e("th",{class:"px-4 py-3 font-medium"},"狀態"),e("th",{class:"px-4 py-3 font-medium"},"執行時間"),e("th",{class:"px-4 py-3 font-medium"},"頻道"),e("th",{class:"px-4 py-3 font-medium"},"訊息"),e("th",{class:"px-4 py-3 font-medium"},"操作")])],-1)),e("tbody",Te,[(r(!0),l(S,null,k(C.value,s=>(r(),l("tr",{key:s.id,class:"bg-white"},[e("td",Ce,[e("p",Ie,a(s.scheduleTitle),1),e("p",Le,"ID: "+a(s.scheduleId),1)]),e("td",Ve,[e("span",{class:J(["px-2 py-1 rounded text-xs font-medium inline-flex items-center gap-1",O(s.status)])},a($(s.status)),3)]),e("td",Ae,[e("p",Be,a(j(s.executedAt)),1),e("p",Fe,a(new Date(s.executedAt).toISOString()),1)]),e("td",Me,[e("p",Ue,a(z(s.channelId)),1),e("p",Ee,a(s.channelId),1)]),e("td",Ne,[s.message?(r(),l("p",ze,a(s.message),1)):(r(),l("p",Oe,"無訊息內容")),s.error?(r(),l("p",$e,"錯誤："+a(s.error),1)):D("",!0),s.discordMessageId?(r(),l("p",je," Discord ID："+a(s.discordMessageId),1)):D("",!0)]),e("td",Ke,[e("button",{type:"button",class:"px-3 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 transition-colors text-xs font-medium",onClick:n=>K(s.scheduleId)}," 編輯排程 ",8,Re)])]))),128))])])]))])]))}});export{He as default};
