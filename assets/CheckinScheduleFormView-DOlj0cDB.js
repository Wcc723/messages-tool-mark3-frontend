import{d as P,c as f,m as W,r as m,o as Y,i as G,a as l,b as t,t as d,e as p,g as a,h as i,v as c,s as h,F as T,l as U,E as H,O as J,w as N,z as I,j as r}from"./index-Dg8mVS7j.js";import{u as Q}from"./checkin-BVocAZFq.js";import{u as X}from"./discord-D0xgS0n4.js";const Z={class:"space-y-6 max-w-4xl mx-auto"},_={class:"text-2xl font-bold text-gray-800"},ee={class:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-4"},te={key:0,class:"text-xs text-red-500 mt-1"},se={key:1,class:"text-xs text-gray-500 mt-1"},ne={class:"relative"},oe={key:0,class:"text-gray-800"},le={key:0,class:"text-xs text-gray-500 ml-2"},re={key:1,class:"text-gray-500"},ae={key:0,class:"absolute z-10 w-full mt-2 bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-auto"},de={class:"p-3 border-b border-gray-200 sticky top-0 bg-white"},ie={class:"py-2"},ue={class:"px-3 py-1 text-xs font-semibold text-gray-500 uppercase"},ce=["onClick"],ge={class:"flex-1 text-sm"},pe={key:0,class:"bi bi-check2 text-indigo-600 text-lg"},xe={key:0,class:"px-4 py-8 text-center text-gray-500 text-sm"},me={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},be={class:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-4"},ve={class:"space-y-3"},ye={class:"flex-1"},fe={key:0,class:"mt-3"},he={class:"flex items-center gap-2"},ke={class:"flex gap-2 mb-2"},we=["onKeydown"],De={key:0,class:"flex flex-wrap gap-2"},Ce=["onClick"],Se={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700"},Me={class:"sticky bottom-0 bg-white border-t border-gray-200 p-4 flex items-center justify-end gap-3"},Ie=["disabled"],Ve={key:0},Te={key:1},Ne=P({__name:"CheckinScheduleFormView",setup(Ue){const V=G(),z=W(),u=Q(),b=X(),v=f(()=>z.params.id),k=f(()=>!!v.value),y=m(""),w=m(!1),D=m(!1),C=m(""),s=m({name:"",slug:"",channelId:"",startDate:"",endDate:"",keywords:[],expectedThreadCount:void 0,checkinMode:"standard",extendedHours:void 0}),S=m("");function E(n){return n?n.length<3||n.length>50?"Slug 長度須為 3-50 字元":/^[a-z0-9-]+$/.test(n)?/^[a-z]/.test(n)?n.endsWith("-")?"Slug 結尾不可為連字號":/--/.test(n)?"Slug 不可包含連續連字號":null:"Slug 開頭必須為英文字母":"Slug 只能包含小寫英文、數字及連字號":null}function K(){S.value=E(s.value.slug)||""}const $=f(()=>{if(!y.value)return b.textChannels;const n=y.value.toLowerCase();return b.textChannels.filter(e=>e.name.toLowerCase().includes(n))}),L=f(()=>{const n={};return $.value.forEach(e=>{const o=e.parentName||"未分類";n[o]||(n[o]=[]),n[o].push(e)}),n}),M=f(()=>b.channels.find(n=>n.id===s.value.channelId));function B(n){s.value.channelId=n,w.value=!1,y.value=""}function F(){const n=C.value.trim();n&&!s.value.keywords.includes(n)&&(s.value.keywords.push(n),C.value="")}function j(n){s.value.keywords.splice(n,1)}function q(){if(!s.value.name.trim())return"請輸入排程名稱";const n=E(s.value.slug);if(n)return n;if(!s.value.channelId)return"請選擇 Discord 頻道";if(!s.value.startDate)return"請選擇開始日期";if(!s.value.endDate)return"請選擇結束日期";const e=new Date(s.value.startDate);if(new Date(s.value.endDate)<e)return"結束日期不可早於開始日期";if(s.value.checkinMode==="extended"){if(!s.value.extendedHours)return"請輸入延後計算時數";if(s.value.extendedHours<1||s.value.extendedHours>72)return"延後計算時數須在 1-72 小時之間"}return null}async function R(){const n=q();if(n){alert(n);return}D.value=!0;try{const e={name:s.value.name.trim(),slug:s.value.slug.trim()||void 0,channelId:s.value.channelId,startDate:s.value.startDate,endDate:s.value.endDate,keywords:s.value.keywords.length>0?s.value.keywords:void 0,expectedThreadCount:s.value.expectedThreadCount,checkinMode:s.value.checkinMode,extendedHours:s.value.checkinMode==="extended"?s.value.extendedHours:void 0};k.value&&v.value?(await u.updateSchedule(v.value,e),alert("排程已更新！")):(await u.createSchedule(e),alert("排程已建立！")),V.push({name:"CheckinSchedules"})}catch(e){console.error("Failed to save schedule:",e),alert(u.error||"操作失敗")}finally{D.value=!1}}function O(){confirm("確定要取消嗎？未儲存的變更將會遺失。")&&V.push({name:"CheckinSchedules"})}function A(){const n=new Date,e=n.getFullYear(),o=String(n.getMonth()+1).padStart(2,"0"),g=String(n.getDate()).padStart(2,"0");return`${e}-${o}-${g}`}return Y(async()=>{if(b.channels.length===0&&await b.fetchChannels(),k.value&&v.value)try{const n=await u.fetchScheduleById(v.value);s.value={name:n.name,slug:n.slug||"",channelId:n.channelId,startDate:n.startDate,endDate:n.endDate,keywords:n.keywords||[],expectedThreadCount:n.expectedThreadCount,checkinMode:n.checkinMode||"standard",extendedHours:n.extendedHours}}catch{alert("載入排程失敗"),V.push({name:"CheckinSchedules"})}else s.value.startDate=A()}),(n,e)=>(r(),l("div",Z,[t("header",null,[t("h1",_,d(k.value?"編輯打卡排程":"新增打卡排程"),1),e[12]||(e[12]=t("p",{class:"text-gray-600 mt-1"},"設定 Discord 頻道的打卡監控排程",-1))]),t("form",{onSubmit:N(R,["prevent"]),class:"space-y-6"},[t("section",ee,[e[21]||(e[21]=t("div",{class:"flex items-center gap-3 border-b border-gray-200 pb-3"},[t("i",{class:"bi bi-info-circle text-indigo-600 text-lg"}),t("h2",{class:"text-lg font-semibold text-gray-800"},"基本設定")],-1)),t("div",null,[e[13]||(e[13]=t("label",{for:"name",class:"block text-sm font-medium text-gray-700 mb-1"},[i(" 排程名稱 "),t("span",{class:"text-red-500"},"*")],-1)),a(t("input",{id:"name","onUpdate:modelValue":e[0]||(e[0]=o=>s.value.name=o),type:"text",required:"",maxlength:"100",placeholder:"例如：2025 年度打卡活動",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[c,s.value.name]])]),t("div",null,[e[14]||(e[14]=t("label",{for:"slug",class:"block text-sm font-medium text-gray-700 mb-1"}," 客製化路由（Slug） ",-1)),a(t("input",{id:"slug","onUpdate:modelValue":e[1]||(e[1]=o=>s.value.slug=o),type:"text",maxlength:"50",placeholder:"例如：react-2025",class:h(["w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500",S.value?"border-red-500":"border-gray-300"]),onInput:K},null,34),[[c,s.value.slug]]),S.value?(r(),l("p",te,d(S.value),1)):(r(),l("p",se," 可用於替代 ID 存取 API，僅限小寫英文、數字及連字號，3-50 字元 "))]),t("div",null,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},[i(" Discord 頻道 "),t("span",{class:"text-red-500"},"*")],-1)),t("div",ne,[t("button",{type:"button",class:"w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer",onClick:e[2]||(e[2]=o=>w.value=!w.value)},[M.value?(r(),l("span",oe,[e[15]||(e[15]=t("i",{class:"bi bi-hash text-gray-400"},null,-1)),i(" "+d(M.value.name)+" ",1),M.value.parentName?(r(),l("span",le," ("+d(M.value.parentName)+") ",1)):p("",!0)])):(r(),l("span",re,"請選擇頻道")),e[16]||(e[16]=t("i",{class:"bi bi-chevron-down text-gray-400"},null,-1))]),w.value?(r(),l("div",ae,[t("div",de,[a(t("input",{"onUpdate:modelValue":e[3]||(e[3]=o=>y.value=o),type:"text",placeholder:"搜尋頻道...",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[c,y.value]])]),t("div",ie,[(r(!0),l(T,null,U(L.value,(o,g)=>(r(),l("div",{key:g,class:"mb-3"},[t("div",ue,d(g),1),(r(!0),l(T,null,U(o,x=>(r(),l("button",{key:x.id,type:"button",class:h(["w-full px-4 py-2 text-left hover:bg-gray-50 cursor-pointer flex items-center gap-2",{"bg-indigo-50":s.value.channelId===x.id}]),onClick:He=>B(x.id)},[e[17]||(e[17]=t("i",{class:"bi bi-hash text-gray-400"},null,-1)),t("span",ge,d(x.name),1),s.value.channelId===x.id?(r(),l("i",pe)):p("",!0)],10,ce))),128))]))),128))]),$.value.length===0?(r(),l("div",xe," 找不到符合的頻道 ")):p("",!0)])):p("",!0)])]),t("div",me,[t("div",null,[e[19]||(e[19]=t("label",{for:"startDate",class:"block text-sm font-medium text-gray-700 mb-1"},[i(" 開始日期 "),t("span",{class:"text-red-500"},"*")],-1)),a(t("input",{id:"startDate","onUpdate:modelValue":e[4]||(e[4]=o=>s.value.startDate=o),type:"date",required:"",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[c,s.value.startDate]])]),t("div",null,[e[20]||(e[20]=t("label",{for:"endDate",class:"block text-sm font-medium text-gray-700 mb-1"},[i(" 結束日期 "),t("span",{class:"text-red-500"},"*")],-1)),a(t("input",{id:"endDate","onUpdate:modelValue":e[5]||(e[5]=o=>s.value.endDate=o),type:"date",required:"",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[c,s.value.endDate]])])])]),t("section",be,[e[36]||(e[36]=t("div",{class:"flex items-center gap-3 border-b border-gray-200 pb-3"},[t("i",{class:"bi bi-sliders text-indigo-600 text-lg"}),t("h2",{class:"text-lg font-semibold text-gray-800"},"進階設定")],-1)),t("div",null,[e[29]||(e[29]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[i(" 打卡計算模式 "),t("span",{class:"text-red-500"},"*")],-1)),t("div",ve,[t("label",{class:h(["flex items-start gap-3 p-3 border rounded-lg cursor-pointer transition",s.value.checkinMode==="standard"?"border-indigo-500 bg-indigo-50":"border-gray-200 hover:border-gray-300"])},[a(t("input",{"onUpdate:modelValue":e[6]||(e[6]=o=>s.value.checkinMode=o),type:"radio",name:"checkinMode",value:"standard",class:"mt-1"},null,512),[[H,s.value.checkinMode]]),e[22]||(e[22]=t("div",{class:"flex-1"},[t("div",{class:"font-medium text-gray-800"},"標準模式（24小時內）"),t("p",{class:"text-xs text-gray-500 mt-1"}," 用戶須在討論串建立後 24 小時內留言，才算打卡成功 ")],-1))],2),t("label",{class:h(["flex items-start gap-3 p-3 border rounded-lg cursor-pointer transition",s.value.checkinMode==="extended"?"border-indigo-500 bg-indigo-50":"border-gray-200 hover:border-gray-300"])},[a(t("input",{"onUpdate:modelValue":e[7]||(e[7]=o=>s.value.checkinMode=o),type:"radio",name:"checkinMode",value:"extended",class:"mt-1"},null,512),[[H,s.value.checkinMode]]),t("div",ye,[e[26]||(e[26]=t("div",{class:"font-medium text-gray-800"},"延後計算時間",-1)),e[27]||(e[27]=t("p",{class:"text-xs text-gray-500 mt-1"}," 用戶在當日結束後的指定時數內留言，仍可被計算為打卡成功 ",-1)),s.value.checkinMode==="extended"?(r(),l("div",fe,[e[24]||(e[24]=t("label",{class:"block text-xs font-medium text-gray-600 mb-1"}," 延後時數（1-72 小時） ",-1)),t("div",he,[a(t("input",{"onUpdate:modelValue":e[8]||(e[8]=o=>s.value.extendedHours=o),type:"number",min:"1",max:"72",placeholder:"12",class:"w-24 px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"},null,512),[[c,s.value.extendedHours,void 0,{number:!0}]]),e[23]||(e[23]=t("span",{class:"text-sm text-gray-500"},"小時",-1))]),e[25]||(e[25]=t("p",{class:"text-xs text-gray-400 mt-1"}," 例如：設定 12 小時，則用戶在隔日中午 12 點前留言皆可計算 ",-1))])):p("",!0)])],2),t("label",{class:h(["flex items-start gap-3 p-3 border rounded-lg cursor-pointer transition",s.value.checkinMode==="all_period"?"border-indigo-500 bg-indigo-50":"border-gray-200 hover:border-gray-300"])},[a(t("input",{"onUpdate:modelValue":e[9]||(e[9]=o=>s.value.checkinMode=o),type:"radio",name:"checkinMode",value:"all_period",class:"mt-1"},null,512),[[H,s.value.checkinMode]]),e[28]||(e[28]=t("div",{class:"flex-1"},[t("div",{class:"font-medium text-gray-800"},"不分時段"),t("p",{class:"text-xs text-gray-500 mt-1"}," 用戶在整個排程期間（開始日期至結束日期）內的任何時間留言，均可被計算為打卡成功 ")],-1))],2)])]),t("div",null,[e[32]||(e[32]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," 關鍵字篩選（可選） ",-1)),e[33]||(e[33]=t("p",{class:"text-xs text-gray-500 mb-2"}," 輸入關鍵字以篩選討論串標題。若不設定，則會截取所有討論串。 ",-1)),t("div",ke,[a(t("input",{"onUpdate:modelValue":e[10]||(e[10]=o=>C.value=o),type:"text",placeholder:"輸入關鍵字...",class:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500",onKeydown:J(N(F,["prevent"]),["enter"])},null,40,we),[[c,C.value]]),t("button",{type:"button",class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition cursor-pointer",onClick:F},[...e[30]||(e[30]=[t("i",{class:"bi bi-plus-lg"},null,-1)])])]),s.value.keywords.length>0?(r(),l("div",De,[(r(!0),l(T,null,U(s.value.keywords,(o,g)=>(r(),l("span",{key:g,class:"inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm"},[i(d(o)+" ",1),t("button",{type:"button",class:"hover:text-blue-600 cursor-pointer",onClick:x=>j(g)},[...e[31]||(e[31]=[t("i",{class:"bi bi-x text-lg"},null,-1)])],8,Ce)]))),128))])):p("",!0)]),t("div",null,[e[34]||(e[34]=t("label",{for:"expectedThreadCount",class:"block text-sm font-medium text-gray-700 mb-1"}," 預期討論串數目（可選） ",-1)),a(t("input",{id:"expectedThreadCount","onUpdate:modelValue":e[11]||(e[11]=o=>s.value.expectedThreadCount=o),type:"number",min:"0",placeholder:"例如：30",class:"w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[c,s.value.expectedThreadCount,void 0,{number:!0}]]),e[35]||(e[35]=t("p",{class:"text-xs text-gray-500 mt-1"},"用於預估排程的討論串總數",-1))])]),I(u).error?(r(),l("div",Se,d(I(u).error),1)):p("",!0),t("div",Me,[t("button",{type:"button",class:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition cursor-pointer",onClick:O}," 取消 "),t("button",{type:"submit",class:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",disabled:D.value||I(u).isLoading},[D.value||I(u).isLoading?(r(),l("span",Ve,[...e[37]||(e[37]=[t("i",{class:"bi bi-arrow-repeat animate-spin"},null,-1),i(" 儲存中... ",-1)])])):(r(),l("span",Te,[e[38]||(e[38]=t("i",{class:"bi bi-check2"},null,-1)),i(" "+d(k.value?"更新排程":"建立排程"),1)]))],8,Ie)])],32)]))}});export{Ne as default};
