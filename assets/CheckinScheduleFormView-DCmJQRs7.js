import{d as q,c as v,m as z,r as f,o as O,i as R,a as r,b as t,t as d,e as p,g,h as i,v as b,F as T,l as V,O as Y,w as N,z as S,s as A,j as l}from"./index-BMKHKagT.js";import{u as G}from"./checkin-DQDXA81x.js";import{u as H}from"./discord-DzunpFyY.js";const J={class:"space-y-6 max-w-4xl mx-auto"},P={class:"text-2xl font-bold text-gray-800"},Q={class:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-4"},W={class:"relative"},X={key:0,class:"text-gray-800"},Z={key:0,class:"text-xs text-gray-500 ml-2"},ee={key:1,class:"text-gray-500"},te={key:0,class:"absolute z-10 w-full mt-2 bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-auto"},se={class:"p-3 border-b border-gray-200 sticky top-0 bg-white"},ne={class:"py-2"},oe={class:"px-3 py-1 text-xs font-semibold text-gray-500 uppercase"},re=["onClick"],le={class:"flex-1 text-sm"},ae={key:0,class:"bi bi-check2 text-indigo-600 text-lg"},de={key:0,class:"px-4 py-8 text-center text-gray-500 text-sm"},ie={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},ue={class:"bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-4"},ce={class:"flex gap-2 mb-2"},pe=["onKeydown"],ge={key:0,class:"flex flex-wrap gap-2"},be=["onClick"],ye={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700"},me={class:"sticky bottom-0 bg-white border-t border-gray-200 p-4 flex items-center justify-end gap-3"},xe=["disabled"],ve={key:0},fe={key:1},Se=q({__name:"CheckinScheduleFormView",setup(he){const I=R(),U=z(),a=G(),y=H(),m=v(()=>U.params.id),h=v(()=>!!m.value),x=f(""),w=f(!1),k=f(!1),D=f(""),n=f({name:"",channelId:"",startDate:"",endDate:"",keywords:[],expectedThreadCount:void 0}),_=v(()=>{if(!x.value)return y.textChannels;const s=x.value.toLowerCase();return y.textChannels.filter(e=>e.name.toLowerCase().includes(s))}),$=v(()=>{const s={};return _.value.forEach(e=>{const o=e.parentName||"未分類";s[o]||(s[o]=[]),s[o].push(e)}),s}),C=v(()=>y.channels.find(s=>s.id===n.value.channelId));function K(s){n.value.channelId=s,w.value=!1,x.value=""}function F(){const s=D.value.trim();s&&!n.value.keywords.includes(s)&&(n.value.keywords.push(s),D.value="")}function L(s){n.value.keywords.splice(s,1)}function M(){if(!n.value.name.trim())return"請輸入排程名稱";if(!n.value.channelId)return"請選擇 Discord 頻道";if(!n.value.startDate)return"請選擇開始日期";if(!n.value.endDate)return"請選擇結束日期";const s=new Date(n.value.startDate);return new Date(n.value.endDate)<s?"結束日期不可早於開始日期":null}async function B(){const s=M();if(s){alert(s);return}k.value=!0;try{const e={name:n.value.name.trim(),channelId:n.value.channelId,startDate:n.value.startDate,endDate:n.value.endDate,keywords:n.value.keywords.length>0?n.value.keywords:void 0,expectedThreadCount:n.value.expectedThreadCount};h.value&&m.value?(await a.updateSchedule(m.value,e),alert("排程已更新！")):(await a.createSchedule(e),alert("排程已建立！")),I.push({name:"CheckinSchedules"})}catch(e){console.error("Failed to save schedule:",e),alert(a.error||"操作失敗")}finally{k.value=!1}}function E(){confirm("確定要取消嗎？未儲存的變更將會遺失。")&&I.push({name:"CheckinSchedules"})}function j(){const s=new Date,e=s.getFullYear(),o=String(s.getMonth()+1).padStart(2,"0"),u=String(s.getDate()).padStart(2,"0");return`${e}-${o}-${u}`}return O(async()=>{if(y.channels.length===0&&await y.fetchChannels(),h.value&&m.value)try{const s=await a.fetchScheduleById(m.value);n.value={name:s.name,channelId:s.channelId,startDate:s.startDate,endDate:s.endDate,keywords:s.keywords||[],expectedThreadCount:s.expectedThreadCount}}catch{alert("載入排程失敗"),I.push({name:"CheckinSchedules"})}else n.value.startDate=j()}),(s,e)=>(l(),r("div",J,[t("header",null,[t("h1",P,d(h.value?"編輯打卡排程":"新增打卡排程"),1),e[7]||(e[7]=t("p",{class:"text-gray-600 mt-1"},"設定 Discord 頻道的打卡監控排程",-1))]),t("form",{onSubmit:N(B,["prevent"]),class:"space-y-6"},[t("section",Q,[e[15]||(e[15]=t("div",{class:"flex items-center gap-3 border-b border-gray-200 pb-3"},[t("i",{class:"bi bi-info-circle text-indigo-600 text-lg"}),t("h2",{class:"text-lg font-semibold text-gray-800"},"基本設定")],-1)),t("div",null,[e[8]||(e[8]=t("label",{for:"name",class:"block text-sm font-medium text-gray-700 mb-1"},[i(" 排程名稱 "),t("span",{class:"text-red-500"},"*")],-1)),g(t("input",{id:"name","onUpdate:modelValue":e[0]||(e[0]=o=>n.value.name=o),type:"text",required:"",maxlength:"100",placeholder:"例如：2025 年度打卡活動",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[b,n.value.name]])]),t("div",null,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},[i(" Discord 頻道 "),t("span",{class:"text-red-500"},"*")],-1)),t("div",W,[t("button",{type:"button",class:"w-full px-4 py-2 border border-gray-300 rounded-lg bg-white text-left flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer",onClick:e[1]||(e[1]=o=>w.value=!w.value)},[C.value?(l(),r("span",X,[e[9]||(e[9]=t("i",{class:"bi bi-hash text-gray-400"},null,-1)),i(" "+d(C.value.name)+" ",1),C.value.parentName?(l(),r("span",Z," ("+d(C.value.parentName)+") ",1)):p("",!0)])):(l(),r("span",ee,"請選擇頻道")),e[10]||(e[10]=t("i",{class:"bi bi-chevron-down text-gray-400"},null,-1))]),w.value?(l(),r("div",te,[t("div",se,[g(t("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>x.value=o),type:"text",placeholder:"搜尋頻道...",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[b,x.value]])]),t("div",ne,[(l(!0),r(T,null,V($.value,(o,u)=>(l(),r("div",{key:u,class:"mb-3"},[t("div",oe,d(u),1),(l(!0),r(T,null,V(o,c=>(l(),r("button",{key:c.id,type:"button",class:A(["w-full px-4 py-2 text-left hover:bg-gray-50 cursor-pointer flex items-center gap-2",{"bg-indigo-50":n.value.channelId===c.id}]),onClick:we=>K(c.id)},[e[11]||(e[11]=t("i",{class:"bi bi-hash text-gray-400"},null,-1)),t("span",le,d(c.name),1),n.value.channelId===c.id?(l(),r("i",ae)):p("",!0)],10,re))),128))]))),128))]),_.value.length===0?(l(),r("div",de," 找不到符合的頻道 ")):p("",!0)])):p("",!0)])]),t("div",ie,[t("div",null,[e[13]||(e[13]=t("label",{for:"startDate",class:"block text-sm font-medium text-gray-700 mb-1"},[i(" 開始日期 "),t("span",{class:"text-red-500"},"*")],-1)),g(t("input",{id:"startDate","onUpdate:modelValue":e[3]||(e[3]=o=>n.value.startDate=o),type:"date",required:"",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[b,n.value.startDate]])]),t("div",null,[e[14]||(e[14]=t("label",{for:"endDate",class:"block text-sm font-medium text-gray-700 mb-1"},[i(" 結束日期 "),t("span",{class:"text-red-500"},"*")],-1)),g(t("input",{id:"endDate","onUpdate:modelValue":e[4]||(e[4]=o=>n.value.endDate=o),type:"date",required:"",class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[b,n.value.endDate]])])])]),t("section",ue,[e[22]||(e[22]=t("div",{class:"flex items-center gap-3 border-b border-gray-200 pb-3"},[t("i",{class:"bi bi-sliders text-indigo-600 text-lg"}),t("h2",{class:"text-lg font-semibold text-gray-800"},"進階設定")],-1)),t("div",null,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"}," 關鍵字篩選（可選） ",-1)),e[19]||(e[19]=t("p",{class:"text-xs text-gray-500 mb-2"}," 輸入關鍵字以篩選討論串標題。若不設定，則會截取所有討論串。 ",-1)),t("div",ce,[g(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>D.value=o),type:"text",placeholder:"輸入關鍵字...",class:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500",onKeydown:Y(N(F,["prevent"]),["enter"])},null,40,pe),[[b,D.value]]),t("button",{type:"button",class:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition cursor-pointer",onClick:F},[...e[16]||(e[16]=[t("i",{class:"bi bi-plus-lg"},null,-1)])])]),n.value.keywords.length>0?(l(),r("div",ge,[(l(!0),r(T,null,V(n.value.keywords,(o,u)=>(l(),r("span",{key:u,class:"inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm"},[i(d(o)+" ",1),t("button",{type:"button",class:"hover:text-blue-600 cursor-pointer",onClick:c=>L(u)},[...e[17]||(e[17]=[t("i",{class:"bi bi-x text-lg"},null,-1)])],8,be)]))),128))])):p("",!0)]),t("div",null,[e[20]||(e[20]=t("label",{for:"expectedThreadCount",class:"block text-sm font-medium text-gray-700 mb-1"}," 預期討論串數目（可選） ",-1)),g(t("input",{id:"expectedThreadCount","onUpdate:modelValue":e[6]||(e[6]=o=>n.value.expectedThreadCount=o),type:"number",min:"0",placeholder:"例如：30",class:"w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[b,n.value.expectedThreadCount,void 0,{number:!0}]]),e[21]||(e[21]=t("p",{class:"text-xs text-gray-500 mt-1"},"用於預估排程的討論串總數",-1))])]),S(a).error?(l(),r("div",ye,d(S(a).error),1)):p("",!0),t("div",me,[t("button",{type:"button",class:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition cursor-pointer",onClick:E}," 取消 "),t("button",{type:"submit",class:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",disabled:k.value||S(a).isLoading},[k.value||S(a).isLoading?(l(),r("span",ve,[...e[23]||(e[23]=[t("i",{class:"bi bi-arrow-repeat animate-spin"},null,-1),i(" 儲存中... ",-1)])])):(l(),r("span",fe,[e[24]||(e[24]=t("i",{class:"bi bi-check2"},null,-1)),i(" "+d(h.value?"更新排程":"建立排程"),1)]))],8,xe)])],32)]))}});export{Se as default};
