import{y as j,d as A,k as N,r as g,C as D,c as w,a as r,w as O,b as e,e as _,x as B,t as d,g as U,A as E,F as P,l as C,h as M,s as V,j as o,K as F,o as z,p as T,v as Q,f as W}from"./index-FtQRB8Rs.js";import{_ as L}from"./RoleBadge.vue_vue_type_script_setup_true_lang-Cu6MNCyH.js";async function q(v){return(await j.get("/api/admin/users",{params:v})).data.data}async function G(v,b){await j.put(`/api/admin/users/${v}/role`,{role:b})}const H={class:"bg-white rounded-xl shadow-2xl max-w-3xl w-full",role:"dialog","aria-modal":"true"},I={class:"px-6 py-4 border-b border-gray-200 flex items-center justify-between"},J={class:"px-6 py-5 space-y-6 max-h-[80vh] overflow-y-auto"},X={class:"flex items-start gap-4"},Y={class:"flex-1"},Z={class:"text-lg font-semibold text-gray-800"},K={class:"text-sm text-gray-500"},ee=["value"],te={class:"text-xs text-gray-500 mt-2"},se={class:"bg-gray-50 border border-gray-200 rounded-lg p-4"},ae={class:"grid md:grid-cols-2 gap-4"},le={class:"text-sm font-semibold text-gray-700"},oe={class:"space-y-1"},re={key:0,class:"bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800"},ne={key:1,class:"bg-red-50 border border-red-200 text-sm text-red-600 rounded-lg p-3"},ie={class:"px-6 py-4 border-t border-gray-200 flex justify-end gap-3"},de=["disabled"],ue={key:0,class:"inline-flex items-center gap-2"},ce={key:1},pe=A({__name:"RoleEditModal",props:{user:{}},emits:["close","saved"],setup(v,{emit:b}){const x=v,p=b,m=N(),u=g(x.user.role),a=g(!1),y=g(null);D(()=>x.user,c=>{u.value=c.role,y.value=null},{immediate:!0});const f=w(()=>u.value!==x.user.role),$=w(()=>Object.entries(m.config.roles).map(([c,t])=>({value:c,label:t.displayName,description:t.description}))),k=w(()=>m.config.roles[u.value]),S={canView:"查看",canViewAll:"查看所有",canCreate:"建立",canEdit:"編輯",canEditAll:"編輯所有",canDelete:"刪除",canDeleteAll:"刪除所有",canManageRoles:"管理角色",canSendMessage:"發送訊息",canManageBot:"管理 Bot",canUpload:"上傳",canViewLogs:"查看日誌",canViewDashboard:"查看儀表板",canManageSettings:"管理設定"},R=w(()=>k.value?Object.entries(k.value.features).map(([c,t])=>({key:c,label:m.config.featureDescriptions[c]??c,actions:Object.entries(t).map(([l,n])=>({key:l,label:S[l]??l,allowed:n}))})):[]);async function h(){if(!a.value){if(u.value===x.user.role){p("close");return}try{a.value=!0,y.value=null,await G(x.user.id,u.value),p("saved",{role:u.value}),p("close")}catch(c){const t=c?.response?.data?.message||c?.message||"更新角色失敗，請稍後再試";y.value=t}finally{a.value=!1}}}return(c,t)=>(o(),r("div",{class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4",onClick:t[3]||(t[3]=O(l=>p("close"),["self"]))},[e("div",H,[e("header",I,[t[5]||(t[5]=e("div",null,[e("h2",{class:"text-xl font-semibold text-gray-800"},"編輯使用者角色"),e("p",{class:"text-sm text-gray-500 mt-1"},"調整使用者的角色與權限設定")],-1)),e("button",{type:"button",class:"text-gray-400 hover:text-gray-600 transition cursor-pointer","aria-label":"Close",onClick:t[0]||(t[0]=l=>p("close"))},[...t[4]||(t[4]=[e("i",{class:"bi bi-x-lg"},null,-1)])])]),e("section",J,[e("div",X,[e("div",Y,[t[6]||(t[6]=e("p",{class:"text-sm text-gray-500"},"使用者",-1)),e("p",Z,d(v.user.name),1),e("p",K,d(v.user.email),1)]),B(L,{role:v.user.role},null,8,["role"])]),e("div",null,[t[7]||(t[7]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"選擇角色",-1)),U(e("select",{"onUpdate:modelValue":t[1]||(t[1]=l=>u.value=l),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},[(o(!0),r(P,null,C($.value,l=>(o(),r("option",{key:l.value,value:l.value},d(l.label),9,ee))),128))],512),[[E,u.value]]),e("p",te,d($.value.find(l=>l.value===u.value)?.description),1)]),e("div",se,[t[8]||(t[8]=e("h3",{class:"font-medium text-gray-700 mb-3"},"權限預覽",-1)),e("div",ae,[(o(!0),r(P,null,C(R.value,l=>(o(),r("div",{key:l.key,class:"bg-white border border-gray-200 rounded-md p-3 space-y-2"},[e("h4",le,d(l.label),1),e("ul",oe,[(o(!0),r(P,null,C(l.actions,n=>(o(),r("li",{key:n.key,class:"text-sm flex items-center gap-2"},[e("i",{class:V([n.allowed?"bi-check-circle text-emerald-500":"bi-x-circle text-gray-300","text-base"])},null,2),e("span",{class:V(n.allowed?"text-gray-700":"text-gray-400")},d(n.label),3)]))),128))])]))),128))])]),f.value?(o(),r("div",re," ⚠️ 變更角色將立即生效，該使用者的權限會同步更新。 ")):_("",!0),y.value?(o(),r("div",ne,d(y.value),1)):_("",!0)]),e("footer",ie,[e("button",{type:"button",class:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition cursor-pointer",onClick:t[2]||(t[2]=l=>p("close"))}," 取消 "),e("button",{type:"button",class:"px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition cursor-pointer disabled:opacity-60 disabled:cursor-not-allowed",disabled:a.value,onClick:h},[a.value?(o(),r("span",ue,[...t[9]||(t[9]=[e("i",{class:"bi bi-arrow-repeat animate-spin"},null,-1),M(" 儲存中… ",-1)])])):(o(),r("span",ce,"確認變更"))],8,de)])])]))}}),ge={class:"space-y-6"},xe={class:"bg-white rounded-xl shadow-sm border border-gray-200 p-4"},ve={class:"flex flex-col md:flex-row md:items-center gap-3"},ye={class:"flex-1 flex items-center gap-3"},be={class:"relative flex-1"},me={key:0,class:"text-sm text-red-500"},fe={class:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"},he={class:"relative"},we={class:"min-w-full divide-y divide-gray-200"},_e={class:"bg-white divide-y divide-gray-200"},ke={key:0},$e={key:1},Pe={class:"px-6 py-4 whitespace-nowrap"},Ce={class:"text-sm font-semibold text-gray-800"},Me={class:"text-xs text-gray-500"},Ve={class:"px-6 py-4 whitespace-nowrap text-sm text-gray-600"},Se={class:"px-6 py-4 whitespace-nowrap"},Re={class:"px-6 py-4 whitespace-nowrap"},Ue={class:"px-6 py-4 whitespace-nowrap text-right"},je=["onClick"],Ae={key:0,class:"px-6 py-3 border-t border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-3 text-sm text-gray-600"},De={class:"flex items-center gap-2"},Be=["disabled"],Ee={class:"px-2"},Le=["disabled"],ze=A({__name:"UserManagementView",setup(v){const b=g([]),x=g(!1),p=g(null),m=g(""),u=g(""),a=g({currentPage:1,totalPages:1,totalCount:0,limit:10}),y=g(!1),f=g(null),{hasPermission:$}=F(),k=w(()=>$("users","canManageRoles"));function S(n){k.value&&(f.value=n,y.value=!0)}function R(){y.value=!1,f.value=null}async function h(n=a.value.currentPage){x.value=!0,p.value=null;try{const s=await q({page:n,limit:a.value.limit,search:m.value||void 0,role:u.value||void 0});b.value=s.users,a.value={...a.value,...s.pagination}}catch(s){const i=s?.response?.data?.message||s?.message||"載入使用者列表時發生錯誤，請稍後再試";p.value=i}finally{x.value=!1}}function c(n){n<1||n>a.value.totalPages||n===a.value.currentPage||(a.value.currentPage=n,h(n))}function t(n){h()}const l=w(()=>b.value.length>0);return D([m,u],()=>{a.value.currentPage=1,h(1)}),z(()=>{h()}),(n,s)=>(o(),r("div",ge,[s[10]||(s[10]=e("header",null,[e("h1",{class:"text-2xl font-bold text-gray-800"},"使用者管理"),e("p",{class:"text-gray-600 mt-1"},"檢視並調整系統使用者的角色與權限")],-1)),e("section",xe,[e("div",ve,[e("div",ye,[e("span",be,[s[4]||(s[4]=e("span",{class:"absolute inset-y-0 left-3 flex items-center text-gray-400"},[e("i",{class:"bi bi-search"})],-1)),U(e("input",{"onUpdate:modelValue":s[0]||(s[0]=i=>m.value=i),type:"text",placeholder:"搜尋姓名或 Email...",class:"w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[Q,m.value]])]),U(e("select",{"onUpdate:modelValue":s[1]||(s[1]=i=>u.value=i),class:"px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"},[...s[5]||(s[5]=[W('<option value="">所有角色</option><option value="super_admin">系統管理員</option><option value="admin">管理員</option><option value="manager">訊息管理員</option><option value="no_permission">無權限</option>',5)])],512),[[E,u.value]])]),p.value?(o(),r("div",me,d(p.value),1)):_("",!0)])]),e("section",fe,[e("div",he,[e("table",we,[s[9]||(s[9]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 使用者 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," Email "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 角色 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 狀態 "),e("th",{class:"px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 操作 ")])],-1)),e("tbody",_e,[x.value?(o(),r("tr",ke,[...s[6]||(s[6]=[e("td",{colspan:"5",class:"px-6 py-10 text-center text-gray-500"},[e("div",{class:"inline-flex items-center gap-2 text-indigo-600"},[e("i",{class:"bi bi-arrow-repeat animate-spin text-lg"}),M(" 讀取使用者資料中... ")])],-1)])])):l.value?(o(!0),r(P,{key:2},C(b.value,i=>(o(),r("tr",{key:i.id,class:"hover:bg-gray-50 transition"},[e("td",Pe,[e("div",null,[e("p",Ce,d(i.name),1),e("p",Me,"建立於 "+d(new Date(i.createdAt).toLocaleDateString()),1)])]),e("td",Ve,d(i.email),1),e("td",Se,[B(L,{role:i.role},null,8,["role"])]),e("td",Re,[e("span",{class:V(["inline-flex items-center gap-2 text-sm font-medium",i.isActive?"text-emerald-600":"text-red-500"])},[e("span",{class:V(["w-2 h-2 rounded-full",i.isActive?"bg-emerald-500":"bg-red-500"])},null,2),M(" "+d(i.isActive?"啟用":"停用"),1)],2)]),e("td",Ue,[k.value?(o(),r("button",{key:0,type:"button",class:"inline-flex items-center gap-2 px-3 py-2 text-sm border border-indigo-200 text-indigo-600 rounded-lg hover:bg-indigo-50 transition cursor-pointer",onClick:Ne=>S(i)},[...s[8]||(s[8]=[e("i",{class:"bi bi-shield-lock"},null,-1),M(" 編輯角色 ",-1)])],8,je)):_("",!0)])]))),128)):(o(),r("tr",$e,[...s[7]||(s[7]=[e("td",{colspan:"5",class:"px-6 py-10 text-center text-gray-500"},[e("div",{class:"flex flex-col items-center gap-2"},[e("i",{class:"bi bi-people text-3xl text-gray-300"}),e("span",null,"尚無符合條件的使用者")])],-1)])]))])]),!x.value&&l.value?(o(),r("div",Ae,[e("div",null," 共 "+d(a.value.totalCount)+" 位使用者，第 "+d(a.value.currentPage)+" / "+d(a.value.totalPages)+" 頁 ",1),e("div",De,[e("button",{type:"button",class:"px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",disabled:a.value.currentPage===1,onClick:s[2]||(s[2]=i=>c(a.value.currentPage-1))}," 上一頁 ",8,Be),e("span",Ee,d(a.value.currentPage)+" / "+d(a.value.totalPages),1),e("button",{type:"button",class:"px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer",disabled:a.value.currentPage===a.value.totalPages,onClick:s[3]||(s[3]=i=>c(a.value.currentPage+1))}," 下一頁 ",8,Le)])])):_("",!0)])]),y.value&&f.value?(o(),T(pe,{key:0,user:f.value,onClose:R,onSaved:t},null,8,["user"])):_("",!0)]))}});export{ze as default};
