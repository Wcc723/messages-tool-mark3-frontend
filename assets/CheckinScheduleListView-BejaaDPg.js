import{d as X,M as Y,c as f,r as u,o as Z,a as n,b as e,e as d,h as p,z as _,F as $,l as L,t as o,w as ee,s as h,g as I,E as N,v as te,i as se,j as a}from"./index-BMKHKagT.js";import{u as ne}from"./checkin-DQDXA81x.js";import{u as ae}from"./discord-DzunpFyY.js";import{u as re}from"./useToast-BrPRHwTH.js";const oe={class:"space-y-6"},le={class:"flex items-center justify-between"},ie={class:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"},de={class:"relative"},ce={class:"min-w-full divide-y divide-gray-200"},ue={class:"bg-white divide-y divide-gray-200"},pe={key:0},ge={key:1},xe={colspan:"7",class:"px-6 py-10 text-center text-gray-500"},ye={class:"flex flex-col items-center gap-2"},ve={class:"px-6 py-4 whitespace-nowrap"},be={class:"text-sm font-semibold text-gray-800"},me={class:"text-xs text-gray-500"},fe={class:"px-6 py-4 whitespace-nowrap"},he={class:"text-sm text-gray-700"},we={class:"px-6 py-4 whitespace-nowrap"},ke={class:"text-sm text-gray-700"},_e={class:"text-xs text-gray-500"},Ce={class:"px-6 py-4"},Se={key:0,class:"flex flex-wrap gap-1"},De={key:1,class:"text-sm text-gray-400"},Me={class:"px-6 py-4 whitespace-nowrap"},Re=["onClick"],Te={class:"px-6 py-4"},$e={class:"flex items-center gap-2"},Ie=["title"],Ve=["onClick"],je={class:"px-6 py-4 whitespace-nowrap text-right"},Ee={class:"inline-flex items-center gap-2"},Le=["onClick"],Ne=["onClick"],Fe=["onClick"],ze=["onClick"],Ae={key:0,class:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700"},Be={class:"bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6 space-y-4"},Ue={class:"space-y-4"},qe={class:"text-sm text-gray-600"},Pe={class:"font-semibold text-gray-800"},Ge={class:"space-y-3"},He={key:0,class:"space-y-2"},Je={key:1,class:"mt-4 p-4 bg-gray-50 rounded-lg"},Ke={class:"flex items-center justify-between mb-2"},Oe=["disabled"],Qe={class:"flex items-center gap-2"},We={class:"text-sm"},Xe={key:0,class:"mt-2 text-xs text-gray-500"},Ye={key:1,class:"mt-2 text-xs text-red-600"},Ze={key:2,class:"mt-3 p-3 bg-white rounded border border-gray-200"},et={class:"text-xs text-gray-600 mt-1"},tt={key:0,class:"text-xs text-gray-500 mt-1"},st={class:"flex items-center justify-end gap-3 pt-4 border-t border-gray-200"},nt=["disabled"],at=["disabled"],rt={key:0,class:"bi bi-arrow-repeat animate-spin"},ut=X({__name:"CheckinScheduleListView",setup(ot){const C=se(),i=ne(),S=ae(),{hasPermission:D}=Y(),g=re(),V=f(()=>D("checkin","canCreate")),F=f(()=>D("checkin","canEdit")),z=f(()=>D("checkin","canDelete")),M=u(!1),R=u(""),T=u(""),c=u("all"),x=u(""),b=u(!1),m=u(null),l=u(null),y=u(null),w=u(!1),A=f(()=>{if(!l.value)return"bg-gray-400";switch(l.value.status){case"queued":return"bg-yellow-500";case"running":return"bg-blue-500";case"completed":return"bg-emerald-500";case"failed":return"bg-red-500";default:return"bg-gray-400"}}),B=f(()=>{if(!l.value)return"未知";switch(l.value.status){case"queued":return"排隊中";case"running":return"掃描中";case"completed":return"已完成";case"failed":return"失敗";default:return l.value.status}});function U(r){const t=S.channels.find(s=>s.id===r);return t?`#${t.name}`:"未知頻道"}async function q(r){try{await navigator.clipboard.writeText(r),g.success("排程 ID 已複製到剪貼簿")}catch(t){console.error("複製失敗:",t),g.error("複製失敗，請手動複製")}}async function P(r,t){if(confirm(`確定要刪除排程「${t}」嗎？此操作無法復原。`))try{await i.deleteSchedule(r),g.success("排程已刪除")}catch{g.error(i.error||"刪除失敗")}}async function G(r){try{await i.toggleSchedule(r)}catch{g.error(i.error||"切換狀態失敗")}}function H(r,t){R.value=r,T.value=t,c.value="all",x.value="",m.value=null,l.value=null,y.value=null,M.value=!0}function k(){M.value=!1,R.value="",T.value="",c.value="all",x.value=""}async function J(){if(c.value==="single"&&!x.value){g.warning("請選擇要掃描的日期");return}b.value=!0;try{const r=await i.rescanSchedule(R.value,c.value==="single"?x.value:void 0);if(r)m.value=r,await j();else{const t=c.value==="all"?"已開始重新掃描全部日期":`已開始重新掃描 ${x.value}`;g.success(t),k()}}catch{g.error(i.error||"掃描失敗")}finally{b.value=!1}}async function j(){if(m.value){w.value=!0;try{l.value=await i.fetchScanStatus(m.value),l.value.status==="completed"&&(y.value=await i.fetchScanResult(m.value))}catch(r){console.error("取得掃描狀態失敗:",r)}finally{w.value=!1}}}function K(r){C.push({name:"CheckinScheduleReport",params:{id:r}})}function O(r){C.push({name:"CheckinScheduleEdit",params:{id:r}})}function E(){C.push({name:"CheckinScheduleCreate"})}const Q=f(()=>(i.schedules?.length??0)>0);return Z(async()=>{S.channels.length===0&&await S.fetchChannels().catch(()=>{});try{await i.fetchSchedules()}catch(r){console.error("載入排程失敗:",r)}}),(r,t)=>(a(),n("div",oe,[e("header",le,[t[4]||(t[4]=e("div",null,[e("h1",{class:"text-2xl font-bold text-gray-800"},"打卡排程管理"),e("p",{class:"text-gray-600 mt-1"},"管理 Discord 頻道的打卡排程設定")],-1)),V.value?(a(),n("button",{key:0,type:"button",class:"inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition cursor-pointer",onClick:E},[...t[3]||(t[3]=[e("i",{class:"bi bi-plus-circle"},null,-1),p(" 新增排程 ",-1)])])):d("",!0)]),e("section",ie,[e("div",de,[e("table",ce,[t[14]||(t[14]=e("thead",{class:"bg-gray-50"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 排程名稱 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," Discord 頻道 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 日期範圍 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 關鍵字 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 狀態 "),e("th",{class:"px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 排程 ID "),e("th",{class:"px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider"}," 操作 ")])],-1)),e("tbody",ue,[_(i).isLoading?(a(),n("tr",pe,[...t[5]||(t[5]=[e("td",{colspan:"7",class:"px-6 py-16 text-center"},[e("div",{class:"flex flex-col items-center gap-3"},[e("div",{class:"relative"},[e("div",{class:"w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"})]),e("div",{class:"text-gray-600"},[e("p",{class:"font-medium"},"載入排程資料中"),e("p",{class:"text-sm text-gray-400 mt-1"},"請稍候...")])])],-1)])])):Q.value?(a(!0),n($,{key:2},L(_(i).schedules||[],s=>(a(),n("tr",{key:s.id,class:"hover:bg-gray-50 transition"},[e("td",ve,[e("div",null,[e("p",be,o(s.name),1),e("p",me," 預期討論串: "+o(s.expectedThreadCount||"-")+" 個 ",1)])]),e("td",fe,[e("p",he,o(U(s.channelId)),1)]),e("td",we,[e("div",ke,[e("div",null,o(s.startDate),1),e("div",_e,"至 "+o(s.endDate),1)])]),e("td",Ce,[s.keywords&&s.keywords.length>0?(a(),n("div",Se,[(a(!0),n($,null,L(s.keywords,(v,W)=>(a(),n("span",{key:W,class:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"},o(v),1))),128))])):(a(),n("span",De,"全部訊息"))]),e("td",Me,[e("button",{type:"button",class:h(["inline-flex items-center gap-2 text-sm font-medium cursor-pointer",s.isActive?"text-emerald-600":"text-gray-400"]),onClick:v=>G(s.id)},[e("span",{class:h(["w-2 h-2 rounded-full",s.isActive?"bg-emerald-500":"bg-gray-400"])},null,2),p(" "+o(s.isActive?"啟用":"停用"),1)],10,Re)]),e("td",Te,[e("div",$e,[e("span",{class:"text-xs font-mono text-gray-600 truncate max-w-[100px]",title:s.id},o(s.id),9,Ie),e("button",{type:"button",class:"text-gray-400 hover:text-gray-600 transition cursor-pointer",title:"複製排程 ID",onClick:v=>q(s.id)},[...t[9]||(t[9]=[e("i",{class:"bi bi-clipboard text-sm"},null,-1)])],8,Ve)])]),e("td",je,[e("div",Ee,[e("button",{type:"button",class:"p-2 text-gray-600 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition cursor-pointer",title:"查看報告",onClick:v=>K(s.id)},[...t[10]||(t[10]=[e("i",{class:"bi bi-bar-chart-line"},null,-1)])],8,Le),e("button",{type:"button",class:"p-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition cursor-pointer",title:"重新掃描",onClick:v=>H(s.id,s.name)},[...t[11]||(t[11]=[e("i",{class:"bi bi-arrow-clockwise"},null,-1)])],8,Ne),F.value?(a(),n("button",{key:0,type:"button",class:"p-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition cursor-pointer",title:"編輯",onClick:v=>O(s.id)},[...t[12]||(t[12]=[e("i",{class:"bi bi-pencil"},null,-1)])],8,Fe)):d("",!0),z.value?(a(),n("button",{key:1,type:"button",class:"p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition cursor-pointer",title:"刪除",onClick:v=>P(s.id,s.name)},[...t[13]||(t[13]=[e("i",{class:"bi bi-trash"},null,-1)])],8,ze)):d("",!0)])])]))),128)):(a(),n("tr",ge,[e("td",xe,[e("div",ye,[t[7]||(t[7]=e("i",{class:"bi bi-clipboard-check text-3xl text-gray-300"},null,-1)),t[8]||(t[8]=e("span",null,"尚無打卡排程",-1)),V.value?(a(),n("button",{key:0,type:"button",class:"mt-2 inline-flex items-center gap-2 px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition cursor-pointer",onClick:E},[...t[6]||(t[6]=[e("i",{class:"bi bi-plus-circle"},null,-1),p(" 建立第一個排程 ",-1)])])):d("",!0)])])]))])])])]),_(i).error?(a(),n("div",Ae,o(_(i).error),1)):d("",!0),M.value?(a(),n("div",{key:1,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",onClick:ee(k,["self"])},[e("div",Be,[e("div",{class:"flex items-center justify-between border-b border-gray-200 pb-3"},[t[16]||(t[16]=e("h3",{class:"text-lg font-semibold text-gray-800"},"重新掃描排程",-1)),e("button",{type:"button",class:"text-gray-400 hover:text-gray-600 transition",onClick:k},[...t[15]||(t[15]=[e("i",{class:"bi bi-x-lg text-xl"},null,-1)])])]),e("div",Ue,[e("p",qe,[t[17]||(t[17]=p(" 排程：",-1)),e("span",Pe,o(T.value),1)]),e("div",Ge,[t[20]||(t[20]=e("label",{class:"block text-sm font-medium text-gray-700"},"掃描範圍",-1)),e("label",{class:h(["flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition",c.value==="all"?"border-indigo-500 bg-indigo-50":"border-gray-300"])},[I(e("input",{type:"radio","onUpdate:modelValue":t[0]||(t[0]=s=>c.value=s),value:"all",class:"w-4 h-4 text-indigo-600"},null,512),[[N,c.value]]),t[18]||(t[18]=e("div",{class:"flex-1"},[e("div",{class:"font-medium text-gray-800"},"掃描全部日期"),e("div",{class:"text-xs text-gray-500"},"重新掃描排程內所有日期的討論串")],-1))],2),e("label",{class:h(["flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition",c.value==="single"?"border-indigo-500 bg-indigo-50":"border-gray-300"])},[I(e("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=s=>c.value=s),value:"single",class:"w-4 h-4 text-indigo-600"},null,512),[[N,c.value]]),t[19]||(t[19]=e("div",{class:"flex-1"},[e("div",{class:"font-medium text-gray-800"},"掃描單一日期"),e("div",{class:"text-xs text-gray-500"},"指定特定日期進行掃描")],-1))],2)]),c.value==="single"?(a(),n("div",He,[t[21]||(t[21]=e("label",{for:"rescanDate",class:"block text-sm font-medium text-gray-700"},[p(" 選擇日期 "),e("span",{class:"text-red-500"},"*")],-1)),I(e("input",{id:"rescanDate",type:"date","onUpdate:modelValue":t[2]||(t[2]=s=>x.value=s),class:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"},null,512),[[te,x.value]])])):d("",!0),m.value?(a(),n("div",Je,[e("div",Ke,[t[23]||(t[23]=e("span",{class:"text-sm font-medium text-gray-700"},"掃描狀態",-1)),e("button",{type:"button",class:"text-sm text-indigo-600 hover:text-indigo-800 inline-flex items-center gap-1 cursor-pointer",disabled:w.value,onClick:j},[e("i",{class:h(["bi bi-arrow-clockwise",{"animate-spin":w.value}])},null,2),t[22]||(t[22]=p(" 刷新 ",-1))],8,Oe)]),e("div",Qe,[e("span",{class:h(["w-2 h-2 rounded-full",A.value])},null,2),e("span",We,o(B.value),1)]),l.value?.progress?(a(),n("div",Xe,[p(" 階段: "+o(l.value.progress.phase)+" ",1),t[25]||(t[25]=e("br",null,null,-1)),p(" 處理中: "+o(l.value.progress.processedThreads)+" / "+o(l.value.progress.totalThreads)+" 討論串 ",1),l.value.progress.currentThread?(a(),n($,{key:0},[t[24]||(t[24]=e("br",null,null,-1)),p(" 目前: "+o(l.value.progress.currentThread.name),1)],64)):d("",!0)])):d("",!0),l.value?.errorMessage?(a(),n("div",Ye," 錯誤: "+o(l.value.errorMessage),1)):d("",!0),y.value?(a(),n("div",Ze,[t[26]||(t[26]=e("p",{class:"text-sm font-medium text-gray-800"},"掃描完成",-1)),e("p",et," 發現 "+o(y.value.threadsFound)+" 個討論串， 記錄 "+o(y.value.checkinsRecorded)+" 筆打卡 ",1),y.value.duration?(a(),n("p",tt," 耗時: "+o(Math.round(y.value.duration/1e3))+" 秒 ",1)):d("",!0)])):d("",!0)])):d("",!0)]),e("div",st,[e("button",{type:"button",class:"px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition disabled:opacity-50",disabled:b.value,onClick:k}," 取消 ",8,nt),e("button",{type:"button",class:"px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2",disabled:b.value,onClick:J},[b.value?(a(),n("i",rt)):d("",!0),e("span",null,o(b.value?"掃描中...":"開始掃描"),1)],8,at)])])])):d("",!0)]))}});export{ut as default};
